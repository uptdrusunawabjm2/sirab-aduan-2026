<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Admin Aduan</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-950 text-white min-h-screen flex">

<!-- SIDEBAR -->
<div class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col">
  <div class="p-4 font-bold border-b border-slate-800">Dashboard Admin</div>
  <div class="flex-1"></div>
  <div class="p-4 border-t border-slate-800">
    <button onclick="logout()" class="w-full bg-red-600 hover:bg-red-700 p-2 rounded">Logout</button>
  </div>
</div>

<!-- MAIN -->
<div class="flex-1 p-6 overflow-x-auto">
<h1 class="text-xl font-bold mb-4 text-center">Dashboard Admin Aduan</h1>

<div id="info" class="text-center text-sm text-slate-400 mb-3"></div>

<div class="overflow-auto border border-slate-800 rounded-lg">
<table class="min-w-full text-xs">
<thead class="bg-slate-900"><tr id="thead"></tr></thead>
<tbody id="tbody"></tbody>
</table>
</div>
</div>

<!-- MODAL -->
<div id="modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
<div class="bg-slate-900 p-5 rounded-lg w-full max-w-lg border border-slate-700">

<h2 class="font-bold mb-2">Update Aduan</h2>
<div id="sid" class="text-xs text-slate-400 mb-3"></div>

<input id="pemeriksa" class="w-full mb-2 p-2 bg-slate-800 rounded border border-slate-700" placeholder="Pemeriksa">
<input id="tglPeriksa" type="date" class="w-full mb-2 p-2 bg-slate-800 rounded border border-slate-700">
<textarea id="hasilPeriksa" class="w-full mb-2 p-2 bg-slate-800 rounded border border-slate-700" placeholder="Hasil Periksa"></textarea>

<input id="teknisi" class="w-full mb-2 p-2 bg-slate-800 rounded border border-slate-700" placeholder="Teknisi">
<input id="tglPenanganan" type="date" class="w-full mb-2 p-2 bg-slate-800 rounded border border-slate-700">
<textarea id="hasilPenanganan" class="w-full mb-2 p-2 bg-slate-800 rounded border border-slate-700" placeholder="Hasil Penanganan"></textarea>

<textarea id="catatan" class="w-full mb-2 p-2 bg-slate-800 rounded border border-slate-700" placeholder="Catatan"></textarea>

<input id="foto" type="file" multiple accept="image/*" class="text-xs mb-3">

<div id="msg" class="text-sm text-center mb-3"></div>

<div class="flex gap-2">
<button onclick="simpan()" class="flex-1 bg-blue-600 hover:bg-blue-700 p-2 rounded">Simpan</button>
<button onclick="closeModal()" class="flex-1 bg-slate-700 hover:bg-slate-600 p-2 rounded">Batal</button>
</div>
</div>
</div>

<script>
/* ================= KONFIG ================= */
const API = "https://script.google.com/macros/s/AKfycbwyiBhW4WoSehZ86jYH8CqW_k-GgTvVJ0QOkc1UT_4kXfY5cJZ0xGsMujELidj76TIcUg/exec";
/* ========================================== */

const key = sessionStorage.getItem("key");
if(!key) location.href="login.html";

const thead = document.getElementById("thead");
const tbody = document.getElementById("tbody");
const info  = document.getElementById("info");

let HEAD=[], ROWS=[], CURRENT_ID="";

async function load(){
  info.textContent = "Memuat data...";
  try{
    const r = await fetch(`${API}?action=all&key=${encodeURIComponent(key)}`);
    const j = await r.json();

    if(j.error){
      info.textContent = "❌ " + j.error;
      return;
    }

    if(!j.header || !j.data){
      info.textContent = "❌ Data API tidak valid";
      return;
    }

    HEAD = j.header;
    ROWS = j.data;

    info.textContent = "Total data: " + ROWS.length;
    render();

  }catch(e){
    info.textContent = "❌ Gagal koneksi API";
  }
}

function render(){
  thead.innerHTML="";
  HEAD.forEach(h=>thead.innerHTML+=`<th class="p-2 border-b border-slate-800 whitespace-nowrap">${h}</th>`);
  thead.innerHTML+=`<th class="p-2 border-b border-slate-800">AKSI</th>`;

  tbody.innerHTML="";
  ROWS.forEach(r=>{
    let tr="<tr class='border-b border-slate-800 hover:bg-slate-900'>";
    r.forEach(c=>tr+=`<td class="p-2 whitespace-nowrap">${c||""}</td>`);
    tr+=`<td class="p-2"><button onclick="openModal('${r[HEAD.indexOf("Submission ID")]}')" class="bg-cyan-600 px-2 py-1 rounded text-xs">Aksi</button></td></tr>`;
    tbody.innerHTML+=tr;
  });
}

function openModal(id){
  CURRENT_ID=id;
  sid.textContent="Submission ID: "+id;
  modal.classList.remove("hidden");
  modal.classList.add("flex");
}

function closeModal(){
  modal.classList.add("hidden");
  foto.value="";
  msg.textContent="";
}

async function simpan(){
  msg.textContent="Menyimpan...";
  let files=[];

  for(let f of foto.files){
    const b64=await toBase64(f);
    files.push({file:b64.split(",")[1], mimeType:f.type});
  }

  const body={
    action:"update",
    key:key,
    id:CURRENT_ID,
    pemeriksa:pemeriksa.value,
    hasilPeriksa:hasilPeriksa.value,
    tglPeriksa:tglPeriksa.value,
    teknisi:teknisi.value,
    hasilPenanganan:hasilPenanganan.value,
    tglPenanganan:tglPenanganan.value,
    catatan:catatan.value,
    status:"SELESAI",
    files:files
  };

  const r=await fetch(API,{method:"POST",body:JSON.stringify(body)});
  const j=await r.json();

  if(j.success){ msg.textContent="✅ Berhasil"; load(); setTimeout(closeModal,800); }
  else msg.textContent="❌ Gagal simpan";
}

function toBase64(f){
  return new Promise(res=>{
    const r=new FileReader();
    r.onload=()=>res(r.result);
    r.readAsDataURL(f);
  });
}

function logout(){
  sessionStorage.clear();
  location.href="login.html";
}

load();
</script>
</body>
</html>
