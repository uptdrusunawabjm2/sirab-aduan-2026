<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Admin Pengaduan</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-white min-h-screen p-6">

<div class="flex justify-between items-center mb-6">
  <h1 class="text-2xl font-bold">üõ† Dashboard Pengaduan</h1>
  <div class="flex gap-2">
    <select id="filter" onchange="render()" class="bg-slate-800 p-2 rounded">
      <option value="">Semua Status</option>
      <option value="pending">Pending</option>
      <option value="diperiksa">Diperiksa</option>
      <option value="selesai">Selesai</option>
    </select>
    <button onclick="window.print()" class="bg-blue-600 px-4 py-2 rounded">Export PDF</button>
  </div>
</div>

<div id="cards" class="grid md:grid-cols-3 gap-4 mb-6"></div>

<div class="overflow-auto rounded-xl border border-slate-800">
<table class="w-full text-sm" id="t"></table>
</div>

<!-- MODAL -->
<div id="modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center">
<div class="bg-slate-900 p-6 rounded-xl w-full max-w-xl space-y-3">
<h2 class="text-xl font-bold mb-1">üìÑ Detail & Timeline</h2>
<p id="mid" class="text-slate-400 text-sm"></p>

<div id="timeline" class="space-y-2 text-sm"></div>

<hr class="border-slate-700 my-2">

<select id="mstatus" class="w-full p-2 rounded bg-slate-800">
<option>Pending</option>
<option>Diperiksa</option>
<option>Selesai</option>
</select>

<textarea id="mnote" placeholder="Catatan penanganan"
class="w-full p-2 rounded bg-slate-800"></textarea>

<input id="mfoto" placeholder="Link foto hasil (Drive)"
class="w-full p-2 rounded bg-slate-800">

<div class="flex justify-between pt-2">
<button onclick="printCard()" class="px-4 py-2 bg-indigo-600 rounded">üñ® Cetak Kartu</button>
<div class="flex gap-2">
<button onclick="modal.classList.add('hidden')" class="px-4 py-2 bg-slate-700 rounded">Tutup</button>
<button onclick="save()" class="px-4 py-2 bg-green-600 rounded">Simpan</button>
</div>
</div>
</div>
</div>

<script>
if(!sessionStorage.getItem("admin")) location.href="login.html";

const API = "https://script.google.com/macros/s/AKfycbwdtVp4lgWaww8jtUHYtpd2Rj2hfbkwdD3T1OSCmSGRwBhGaDK_cgbE7YlpvwRnUuLP/exec";
const KEY = "12345";

let RAW=[], HEADER=[], CURRENT_ROW=[], CID="";

function val(h,d,name){
  const i = h.findIndex(x=>x.toLowerCase().includes(name));
  return i>-1 ? String(d[i]||"").trim() : "";
}

/* ===== STATUS OTOMATIS ===== */
function getStatus(h,d){
  const p = val(h,d,"pemeriksa") && val(h,d,"hasil periksa") && val(h,d,"tanggal periksa");
  const s = val(h,d,"teknisi") && val(h,d,"hasil penanganan") && val(h,d,"tanggal penanganan");
  if(s) return {t:"SELESAI",c:"green"};
  if(p) return {t:"DIPERIKSA",c:"yellow"};
  return {t:"PENDING",c:"red"};
}

function badge(st){
  if(st.c=="green") return `<span class="px-2 py-1 rounded bg-green-600 text-xs">SELESAI</span>`;
  if(st.c=="yellow") return `<span class="px-2 py-1 rounded bg-yellow-500 text-black text-xs">DIPERIKSA</span>`;
  return `<span class="px-2 py-1 rounded bg-red-600 text-xs">PENDING</span>`;
}

async function load(){
  const r = await fetch(`${API}?action=all&key=${KEY}`);
  const j = await r.json();
  RAW=j.data; HEADER=j.header;
  renderCards(); render();
}

function renderCards(){
  let p=0,d=0,s=0;
  RAW.forEach(r=>{
    const st=getStatus(HEADER,r).t;
    if(st=="SELESAI") s++;
    else if(st=="DIPERIKSA") d++;
    else p++;
  });

  cards.innerHTML=`
  <div class="bg-red-600/20 border border-red-600 p-4 rounded-xl">Pending<br><b class="text-2xl">${p}</b></div>
  <div class="bg-yellow-500/20 border border-yellow-500 p-4 rounded-xl">Diperiksa<br><b class="text-2xl">${d}</b></div>
  <div class="bg-green-600/20 border border-green-600 p-4 rounded-xl">Selesai<br><b class="text-2xl">${s}</b></div>`;
}

function render(){
  const f = filter.value;
  let h="<tr class='bg-slate-800'>";
  HEADER.forEach(x=>h+=`<th class='p-2 text-left'>${x}</th>`);
  h+="<th>Status</th><th>Aksi</th></tr>";

  RAW.forEach(r=>{
    const st=getStatus(HEADER,r);
    if(f && !st.t.toLowerCase().includes(f)) return;

    h+="<tr class='border-b border-slate-800 hover:bg-slate-900'>";
    r.forEach(x=>h+=`<td class='p-2'>${x||""}</td>`);
    h+=`<td class='p-2'>${badge(st)}</td>`;
    h+=`<td class='p-2'><button onclick='openModal("${r[0]}")' class='text-blue-400'>Detail</button></td></tr>`;
  });

  t.innerHTML=h;
}

function openModal(id){
  CID=id;
  CURRENT_ROW = RAW.find(r=>String(r[0])===String(id));
  mid.innerText="Submission ID: "+id;
  buildTimeline();
  modal.classList.remove("hidden");
}

function buildTimeline(){
  const masuk = true;
  const diperiksa = val(HEADER,CURRENT_ROW,"pemeriksa") && val(HEADER,CURRENT_ROW,"hasil periksa");
  const ditangani = val(HEADER,CURRENT_ROW,"teknisi") && val(HEADER,CURRENT_ROW,"hasil penanganan");
  const selesai = ditangani;

  timeline.innerHTML=`
  <div class="${masuk?'text-green-400':'text-slate-500'}">‚óè Laporan Masuk</div>
  <div class="${diperiksa?'text-yellow-400':'text-slate-500'}">‚óè Diperiksa</div>
  <div class="${ditangani?'text-blue-400':'text-slate-500'}">‚óè Ditangani</div>
  <div class="${selesai?'text-green-400':'text-slate-500'}">‚óè Selesai</div>`;
}

function save(){
  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"update",
      key:KEY,
      id:CID,
      status:mstatus.value,
      catatan:mnote.value,
      foto:mfoto.value
    })
  }).then(()=>location.reload());
}

/* ===== CETAK KARTU ===== */
function printCard(){
  sessionStorage.setItem("printData",JSON.stringify({header:HEADER,data:CURRENT_ROW}));
  window.open("print.html","_blank");
}

load();
</script>
</body>
</html>
