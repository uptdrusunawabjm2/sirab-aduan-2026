<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Data Aduan</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<script src="https://cdn.tailwindcss.com"></script>

<style>
.watermark{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  pointer-events:none;
  z-index:0;
}
.watermark span{
  font-size:8vw;
  font-weight:900;
  color:rgba(255,255,255,0.04);
  transform:rotate(-25deg);
  user-select:none;
  white-space:nowrap;
}
</style>
</head>

<body class="bg-slate-950 text-white min-h-screen p-4 relative">

<div class="watermark"><span>DATA ADUAN</span></div>

<div class="max-w-7xl mx-auto space-y-4 relative z-10">

  <div class="text-center">
    <h1 class="text-2xl md:text-3xl font-bold">Tabel Aduan</h1>
    <p class="text-slate-400 text-sm">hasil pekerjaan wajib dilaporkan ke admin</p>
  </div>

  <!-- FILTER -->
  <div class="grid md:grid-cols-5 gap-2">
    <input id="search" oninput="applyFilter()" placeholder="üîç Cari data..."
      class="p-2 rounded bg-slate-800 border border-slate-700">

    <select id="filterRusun" onchange="applyFilter()"
      class="p-2 rounded bg-slate-800 border border-slate-700">
      <option value="">Semua Rusunawa</option>
    </select>

    <select id="filterStatus" onchange="applyFilter()"
      class="p-2 rounded bg-slate-800 border border-slate-700">
      <option value="">Semua Status</option>
      <option value="PENDING">PENDING</option>
      <option value="DIPERIKSA">DIPERIKSA</option>
      <option value="SELESAI">SELESAI</option>
    </select>

    <input id="fromDate" type="date" onchange="applyFilter()"
      class="p-2 rounded bg-slate-800 border border-slate-700">

    <input id="toDate" type="date" onchange="applyFilter()"
      class="p-2 rounded bg-slate-800 border border-slate-700">
  </div>

  <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-auto max-h-[70vh]">
    <table class="w-full text-sm" id="table"></table>
  </div>

  <!-- PAGINATION -->
  <div class="flex flex-wrap items-center justify-center gap-2 text-sm">
    <button onclick="prevPage()" class="px-3 py-1 rounded bg-slate-800 border border-slate-700">‚èÆ Prev</button>
    <div id="pages" class="flex flex-wrap gap-1"></div>
    <button onclick="nextPage()" class="px-3 py-1 rounded bg-slate-800 border border-slate-700">Next ‚è≠</button>
  </div>

</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbwyiBhW4WoSehZ86jYH8CqW_k-GgTvVJ0QOkc1UT_4kXfY5cJZ0xGsMujELidj76TIcUg/exec";
const PUBLIC_KEY = "rusun2026";
const PER_PAGE = 10;

const SHOW_COLS = [
  "Submission ID","Submission Date","RUSUNAWA","NAMA LENGKAP",
  "NOMOR HP/WA","NOMOR UNIT/SARUSUNAWA","ISI LAPORAN",
  "FOTO DOKUMENTASI","JANJI TEMU","PERNYATAAN"
];

let HEAD=[], RAW=[], FILTERED=[];
let IDX_DATE=-1, IDX_RUSUN=-1;
let PAGE=1;

load();
async function load(){
  const r = await fetch(`${API}?action=all&key=${PUBLIC_KEY}`);
  const j = await r.json();
  HEAD=j.header; RAW=j.data;

  IDX_DATE = HEAD.indexOf("Submission Date");
  IDX_RUSUN = HEAD.indexOf("RUSUNAWA");

  RAW.sort((a,b)=> new Date(b[IDX_DATE]) - new Date(a[IDX_DATE]));
  buildRusun();
  applyFilter();
}

function buildRusun(){
  let s=new Set();
  RAW.forEach(r=>s.add(r[IDX_RUSUN]));
  [...s].filter(Boolean).forEach(v=>{
    filterRusun.innerHTML+=`<option value="${v}">${v}</option>`;
  });
}

function applyFilter(){
  PAGE=1;
  const q=search.value.toLowerCase();
  const rusun=filterRusun.value;
  const st=filterStatus.value;
  const from=fromDate.value?new Date(fromDate.value):null;
  const to=toDate.value?new Date(toDate.value):null;

  FILTERED = RAW.filter(r=>{
    if(q && !r.join(" ").toLowerCase().includes(q)) return false;
    if(rusun && r[IDX_RUSUN]!==rusun) return false;

    const status=getStatus(r);
    if(st && status!==st) return false;

    if(from || to){
      const d=new Date(r[IDX_DATE]);
      if(from && d<from) return false;
      if(to){const t=new Date(to);t.setHours(23,59,59,999);if(d>t) return false;}
    }
    return true;
  });

  renderTable(); renderPages();
}

function renderTable(){
  const start=(PAGE-1)*PER_PAGE;
  const rows=FILTERED.slice(start,start+PER_PAGE);
  const cols=HEAD.map((h,i)=>({h,i})).filter(x=>SHOW_COLS.includes(x.h));

  let h="<tr class='bg-slate-800 sticky top-0'>";
  cols.forEach(c=>h+=`<th class="p-2 border border-slate-700">${c.h}</th>`);
  h+="<th class='p-2 border border-slate-700'>STATUS</th></tr>";

  rows.forEach(r=>{
    const st=getStatus(r);
    h+="<tr class='hover:bg-slate-800'>";
    cols.forEach(c=>{
      let val=r[c.i]||"";
      if(c.h==="Submission Date") val=fmt(val);
      if(c.h==="NOMOR HP/WA") val=maskHP(val);
      if(c.h.toLowerCase().includes("foto")) val=foto(val);
      h+=`<td class="p-2 border border-slate-800">${val}</td>`;
    });
    h+=`<td class="p-2 border border-slate-800 text-center">${badge(st)}</td></tr>`;
  });

  table.innerHTML=h;
}

function getStatus(r){
  const m={}; HEAD.forEach((h,i)=>m[h]=r[i]);
  if(m["Teknisi"]&&m["Tanggal Penanganan"]&&m["Hasil Penanganan"]) return "SELESAI";
  if(m["Pemeriksa"]&&m["Tanggal Periksa"]&&m["Hasil Periksa"]) return "DIPERIKSA";
  return "PENDING";
}

function badge(st){
  if(st==="SELESAI") return `<span class="bg-green-600/20 text-green-400 px-2 py-1 rounded text-xs">SELESAI</span>`;
  if(st==="DIPERIKSA") return `<span class="bg-blue-600/20 text-blue-400 px-2 py-1 rounded text-xs">DIPERIKSA</span>`;
  return `<span class="bg-yellow-400/20 text-yellow-300 px-2 py-1 rounded text-xs">PENDING</span>`;
}

function renderPages(){
  pages.innerHTML="";
  const total=Math.ceil(FILTERED.length/PER_PAGE)||1;
  for(let i=1;i<=total;i++){
    const b=document.createElement("button");
    b.textContent=i;
    b.className="px-3 py-1 rounded border "+(i===PAGE?"bg-blue-600 border-blue-500":"bg-slate-800 border-slate-700");
    b.onclick=()=>{PAGE=i;renderTable();renderPages();};
    pages.appendChild(b);
  }
}
function prevPage(){if(PAGE>1){PAGE--;renderTable();renderPages();}}
function nextPage(){const t=Math.ceil(FILTERED.length/PER_PAGE)||1;if(PAGE<t){PAGE++;renderTable();renderPages();}}

function fmt(v){const d=new Date(v);return isNaN(d)?v:d.toLocaleDateString("id-ID",{day:"2-digit",month:"long",year:"numeric"});}
function foto(v){if(!v) return "";return String(v).split(/\n|,/).map(x=>`<a href="${x.trim()}" target="_blank" class="text-cyan-400 underline mr-2">lihat</a>`).join("");}
function maskHP(v){v=String(v||"").replace(/\D/g,"");return v.length<7?v:v.substring(0,4)+"****"+v.substring(v.length-4);}
</script>

</body>
</html>
