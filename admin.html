<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Admin Aduan</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-950 text-white min-h-screen md:flex">

<div id="sidebar" class="hidden md:flex w-0 md:w-64 bg-slate-900 border-r border-slate-800 flex-col transition-all duration-300">

  <div class="p-4 border-b border-slate-800">
    <div class="text-xl font-bold">Admin Panel</div>
    <div class="text-xs text-slate-400">Pengaduan Rusunawa</div>
  </div>

  <div class="flex-1 p-4 space-y-2 text-sm">
    <div class="p-2 rounded bg-slate-800">ðŸ“‹ Data Aduan</div>
  </div>

  <div class="p-4 border-t border-slate-800">
    <button onclick="logout()" class="w-full bg-red-600/20 text-red-400 border border-red-600 px-3 py-2 rounded hover:bg-red-600 hover:text-white transition">
      ðŸšª Logout
    </button>
  </div>

</div>

<div class="flex-1 flex flex-col">

<div class="bg-slate-900 border-b border-slate-800 p-3 flex items-center gap-3">
  <button onclick="toggleSidebar()" class="bg-slate-800 px-3 py-1 rounded">â˜°</button>
  <div class="font-semibold flex-1 text-center">Dashboard Admin Aduan</div>
</div>



<div class="p-4 space-y-4">

<div class="grid grid-cols-1 md:grid-cols-2 gap-3 max-w-4xl mx-auto">

  <div class="bg-purple-600/20 border border-purple-600 rounded-xl p-4">
    <div class="text-purple-300 text-sm">User Login Aktif</div>
    <div id="rUsers" class="text-2xl font-bold text-purple-400">0</div>
  </div>

  <div class="bg-emerald-600/20 border border-emerald-600 rounded-xl p-4">
    <div class="text-emerald-300 text-sm">Admin Online</div>
    <div id="rOnline" class="text-2xl font-bold text-emerald-400">0</div>
  </div>

</div>

<div class="grid grid-cols-2 md:grid-cols-4 gap-3">
  <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
    <div class="text-slate-400 text-sm">Total Aduan</div>
    <div id="rTotal" class="text-2xl font-bold">0</div>
  </div>
  <div class="bg-yellow-500/20 border border-yellow-500 rounded-xl p-4">
    <div class="text-yellow-300 text-sm">Menunggu</div>
    <div id="rPending" class="text-2xl font-bold text-yellow-400">0</div>
  </div>
  <div class="bg-blue-600/20 border border-blue-600 rounded-xl p-4">
    <div class="text-blue-300 text-sm">Diperiksa</div>
    <div id="rPeriksa" class="text-2xl font-bold text-blue-400">0</div>
  </div>
  <div class="bg-green-600/20 border border-green-600 rounded-xl p-4">
    <div class="text-green-300 text-sm">Selesai</div>
    <div id="rSelesai" class="text-2xl font-bold text-green-400">0</div>
  </div>
</div>

<!-- FILTER -->
<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2">

  <input id="search" oninput="renderTable()" placeholder="ðŸ” Cari data..."
    class="p-2 rounded bg-slate-800 border border-slate-700">

  <select id="filterRusun" onchange="renderTable()"
    class="p-2 rounded bg-slate-800 border border-slate-700">
    <option value="">Semua Rusunawa</option>
  </select>

  <select id="filterStatus" onchange="renderTable()"
    class="p-2 rounded bg-slate-800 border border-slate-700">
    <option value="">Semua Status</option>
    <option value="PENDING">Menunggu</option>
    <option value="DIPERIKSA">Diperiksa</option>
    <option value="SELESAI">Selesai</option>
  </select>

  <select id="filterTahun" onchange="applyYear()"
    class="p-2 rounded bg-slate-800 border border-slate-700">
    <option value="">Semua Tahun</option>
  </select>

  <input id="fromDate" type="date" onchange="renderTable()"
    class="p-2 rounded bg-slate-800 border border-slate-700">

  <input id="toDate" type="date" onchange="renderTable()"
    class="p-2 rounded bg-slate-800 border border-slate-700">

  <button onclick="resetFilter()"
    class="sm:col-span-2 md:col-span-3 lg:col-span-6 bg-red-600/20 border border-red-600 text-red-400 px-3 py-2 rounded hover:bg-red-600 hover:text-white transition">
    ðŸ”„ Reset Filter
  </button>

  <button onclick="exportExcel()"
    class="sm:col-span-2 md:col-span-3 lg:col-span-6 bg-emerald-600 hover:bg-emerald-700 transition rounded px-4 py-2 font-semibold">
    ðŸ“¤ Export Excel
  </button>
</div>

<div class="bg-slate-900 border border-slate-800 rounded-xl overflow-auto max-h-[65vh]">
  <table class="w-full text-sm" id="table"></table>
</div>

</div>
</div>

<!-- MODAL -->
<div id="modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4 z-50">
<div class="bg-slate-900 border border-slate-800 rounded-xl p-4 w-full max-w-lg space-y-2">

<h2 class="text-lg font-bold">Update Aduan</h2>
<div class="text-xs text-slate-400" id="mid"></div>

<input id="pemeriksa" placeholder="Pemeriksa" class="w-full p-2 rounded bg-slate-800 border border-slate-700">
<input id="tglPeriksa" type="date" class="w-full p-2 rounded bg-slate-800 border border-slate-700">
<textarea id="hasilPeriksa" placeholder="Hasil Periksa" class="w-full p-2 rounded bg-slate-800 border border-slate-700"></textarea>

<input id="teknisi" placeholder="Teknisi" class="w-full p-2 rounded bg-slate-800 border border-slate-700">
<input id="tglPenanganan" type="date" class="w-full p-2 rounded bg-slate-800 border border-slate-700">
<textarea id="hasilPenanganan" placeholder="Hasil Penanganan" class="w-full p-2 rounded bg-slate-800 border border-slate-700"></textarea>

<textarea id="catatan" placeholder="Catatan" class="w-full p-2 rounded bg-slate-800 border border-slate-700"></textarea>

<input id="foto" type="file" accept="image/*" multiple class="text-xs">

<div class="flex gap-2 pt-2">
  <button onclick="simpan()" class="flex-1 bg-blue-600 p-2 rounded">Simpan</button>
  <button onclick="closeModal()" class="flex-1 bg-slate-700 p-2 rounded">Batal</button>
</div>

<div id="msg" class="text-center text-sm"></div>
</div>
</div>

<script>
/* ======================= KONFIG ======================= */
const API = "https://script.google.com/macros/s/AKfycbwyiBhW4WoSehZ86jYH8CqW_k-GgTvVJ0QOkc1UT_4kXfY5cJZ0xGsMujELidj76TIcUg/exec";
const key = sessionStorage.getItem("adminKey");
const ADMIN_ID = "ADM-" + Math.random().toString(36).substring(2,9);
const sidebar = document.getElementById("sidebar");

if(!key) location.href="login.html";

let HEAD=[], DATA=[], RAW=[], SID="";
const HIDE_COLS = ["FOTO DOKUMENTASI","JANJI TEMU","PERNYATAAN","Status","EMAIL"];


load();

/* ======================= LOAD ======================= */
async function load(){
  const r = await fetch(`${API}?action=all&key=${key}`);
  const j = await r.json();

  if(j.users!==undefined) rUsers.textContent=j.users;
  if(j.online!==undefined) rOnline.textContent=j.online;
  
  HEAD=j.header; RAW=j.data;

  const idx = HEAD.indexOf("Submission Date");
  RAW.sort((a,b)=> new Date(b[idx]) - new Date(a[idx]));

  DATA=[...RAW];
  buildYear();
  buildRusun();
  hitungRekap();
  renderTable();
}

/* ======================= FILTER BUILDER ======================= */
function buildRusun(){
  const idx = HEAD.indexOf("RUSUNAWA");
  filterRusun.innerHTML = '<option value="">Semua Rusunawa</option>';
  let s = new Set();
  RAW.forEach(r => s.add(r[idx]));
  [...s].filter(Boolean).forEach(v=>{
    filterRusun.innerHTML += `<option value="${v}">${v}</option>`;
  });
}

function resetFilter(){
  search.value="";
  filterStatus.value="";
  filterTahun.value="";
  filterRusun.value="";
  fromDate.value="";
  toDate.value="";
  DATA=[...RAW];
  hitungRekap();
  renderTable();
}

/* ======================= TABLE ======================= */
function renderTable(){
  const rows = getVisibleRows();
  let cols = HEAD.map((h,i)=>({h,i})).filter(x=>!HIDE_COLS.includes(x.h));

  cols.sort((a,b)=>{
    if(a.h==="Submission ID") return -1;
    if(b.h==="Submission ID") return 1;
    return 0;
  });

  let h="<tr class='bg-slate-800 sticky top-0'>";
  cols.forEach(c=>h+=`<th class="p-2 border border-slate-700 text-left">${c.h.toUpperCase()}</th>`);
  h+="<th class='p-2 border border-slate-700 text-center'>STATUS</th>";
  h+="<th class='p-2 border border-slate-700 text-center'>AKSI</th></tr>";

  rows.forEach(r=>{
    const st=getStatus(r);
    h+="<tr class='hover:bg-slate-800'>";
    cols.forEach(c=>{
      let val=r[c.i]||"";
      if(c.h==="Submission Date"||c.h==="Tanggal Periksa"||c.h==="Tanggal Penanganan") val=formatTanggal(val);
      if(c.h.toLowerCase().includes("foto")) val=renderFotoCell(val);
      h+=`<td class="p-2 border border-slate-800 align-top">${val}</td>`;
    });
    h+=`<td class="p-2 border border-slate-800 text-center">${badge(st)}</td>`;
    h+=`<td class="p-2 border border-slate-800 text-center">
    <button onclick='openModal(${JSON.stringify(r)})' class="bg-blue-600 px-3 py-1 rounded text-xs">Aksi</button></td></tr>`;
  });

  table.innerHTML=h;
}

/* ======================= FILTER LOGIC ======================= */
function getVisibleRows(){
  const q=search.value.toLowerCase();
  const f=filterStatus.value;
  const rusun=filterRusun.value;
  const from=fromDate.value?new Date(fromDate.value):null;
  const to=toDate.value?new Date(toDate.value):null;

  const idxDate=HEAD.indexOf("Submission Date");
  const idxRusun=HEAD.indexOf("RUSUNAWA");

  return DATA.filter(r=>{
    const txt=r.join(" ").toLowerCase();
    const st=getStatus(r);

    if(q && !txt.includes(q)) return false;
    if(f && st!==f) return false;
    if(rusun && r[idxRusun]!==rusun) return false;

    if(from||to){
      const d=new Date(r[idxDate]);
      if(from && d<from) return false;
      if(to){const t=new Date(to);t.setHours(23,59,59,999);if(d>t) return false;}
    }
    return true;
  });
}

/* ======================= FUNGSI LAMA ======================= */

function openModal(row){
  const m={}; HEAD.forEach((h,i)=>m[h]=row[i]);
  SID=m["Submission ID"];
  mid.textContent="Submission ID: "+SID;

  pemeriksa.value=m["Pemeriksa"]||"";
  hasilPeriksa.value=m["Hasil Periksa"]||"";
  teknisi.value=m["Teknisi"]||"";
  hasilPenanganan.value=m["Hasil Penanganan"]||"";
  catatan.value=m["Catatan"]||"";
  tglPeriksa.value=toInputDate(m["Tanggal Periksa"]);
  tglPenanganan.value=toInputDate(m["Tanggal Penanganan"]);

  modal.classList.remove("hidden");
  modal.classList.add("flex");
}

/* ========== TAMBAHAN: KOMPRES FOTO ========== */
async function compressImage(file, maxSize=1280, quality=0.7){
  return new Promise(res=>{
    const img=new Image(), r=new FileReader();
    r.onload=e=>{
      img.onload=()=>{
        let w=img.width, h=img.height;
        if(w>h && w>maxSize){ h*=maxSize/w; w=maxSize; }
        else if(h>maxSize){ w*=maxSize/h; h=maxSize; }
        const c=document.createElement("canvas");
        c.width=w; c.height=h;
        c.getContext("2d").drawImage(img,0,0,w,h);
        res(c.toDataURL("image/jpeg",quality));
      };
      img.src=e.target.result;
    };
    r.readAsDataURL(file);
  });
}
/* =========================================== */

async function simpan(){
  msg.textContent="Mengompres foto...";
  let files=[];
  for(let f of foto.files){
    const compressed = await compressImage(f);
    files.push({file:compressed.split(",")[1], mimeType:"image/jpeg"});
  }

  const body={
    action:"update", key, id:SID,
    pemeriksa:pemeriksa.value,
    hasilPeriksa:hasilPeriksa.value,
    tglPeriksa:tglPeriksa.value,
    teknisi:teknisi.value,
    hasilPenanganan:hasilPenanganan.value,
    tglPenanganan:tglPenanganan.value,
    catatan:catatan.value,
    files:files
  };

  const r=await fetch(API,{method:"POST",body:JSON.stringify(body)});
  const j=await r.json();

  if(j.success){
    msg.textContent="âœ… Berhasil";
    load();
    setTimeout(closeModal,800);
  } else msg.textContent="âŒ Gagal";
}

function closeModal(){
  modal.classList.add("hidden");
  modal.classList.remove("flex");
  foto.value="";
  msg.textContent="";
}

function toInputDate(v){
  if(!v) return "";
  const d=new Date(v); if(isNaN(d)) return "";
  return d.toISOString().split("T")[0];
}

function toBase64(f){
  return new Promise(res=>{
    const r=new FileReader();
    r.onload=()=>res(r.result);
    r.readAsDataURL(f);
  });
}

function renderFotoCell(val){
  if(!val) return "";
  const links=String(val).split(/\n|,/).map(x=>x.trim()).filter(Boolean);
  if(links.length===1) return `<a href="${links[0]}" target="_blank" class="text-cyan-400 hover:underline">Lihat foto</a>`;
  return links.map((l,i)=>`<a href="${l}" target="_blank" class="text-cyan-400 hover:underline block">Lihat foto ${i+1}</a>`).join("");
}

function buildYear(){
  const idx=HEAD.indexOf("Submission Date");
  let years=[...new Set(RAW.map(r=>{const d=new Date(r[idx]);return isNaN(d)?null:d.getFullYear();}).filter(Boolean))].sort((a,b)=>b-a);
  filterTahun.innerHTML='<option value="">Semua Tahun</option>';
  years.forEach(y=>filterTahun.innerHTML+=`<option value="${y}">${y}</option>`);
}

function applyYear(){
  const y=filterTahun.value;
  if(!y) DATA=[...RAW];
  else{
    const idx=HEAD.indexOf("Submission Date");
    DATA=RAW.filter(r=>{const d=new Date(r[idx]);return !isNaN(d)&&d.getFullYear()==y});
  }
  hitungRekap();
  renderTable();
}

function getStatus(row){
  const m={}; HEAD.forEach((h,i)=>m[h]=row[i]);
  if(m["Teknisi"]&&m["Tanggal Penanganan"]&&m["Hasil Penanganan"]) return "SELESAI";
  if(m["Pemeriksa"]&&m["Tanggal Periksa"]&&m["Hasil Periksa"]) return "DIPERIKSA";
  return "PENDING";
}

function hitungRekap(){
  let p=0,d=0,s=0;
  DATA.forEach(r=>{
    const st=getStatus(r);
    if(st==="PENDING") p++;
    else if(st==="DIPERIKSA") d++;
    else if(st==="SELESAI") s++;
  });
  rTotal.textContent=DATA.length;
  rPending.textContent=p;
  rPeriksa.textContent=d;
  rSelesai.textContent=s;
}

function formatTanggal(val){
  if(!val) return "";
  const d=new Date(val);
  if(isNaN(d)) return val;
  return d.toLocaleDateString("id-ID",{day:"2-digit",month:"long",year:"numeric"});
}

function badge(st){
  if(st==="SELESAI") return `<span class="bg-green-600/20 text-green-400 px-2 py-1 rounded text-xs">SELESAI</span>`;
  if(st==="DIPERIKSA") return `<span class="bg-blue-600/20 text-blue-400 px-2 py-1 rounded text-xs">DIPERIKSA</span>`;
  return `<span class="bg-yellow-400/20 text-yellow-300 px-2 py-1 rounded text-xs">MENUNGGU</span>`;
}

function toggleSidebar(){

  // MOBILE
  if(window.innerWidth < 768){
    sidebar.classList.toggle("w-64");
    sidebar.classList.toggle("w-0");
    sidebar.classList.toggle("fixed");
    sidebar.classList.toggle("z-50");
    sidebar.classList.toggle("h-full");
    sidebar.classList.toggle("left-0");
    sidebar.classList.toggle("top-0");
    return;
  }

  // DESKTOP (BENAR2 HIDE)
  if(sidebar.classList.contains("hidden")){
    sidebar.classList.remove("hidden");
  }else{
    sidebar.classList.add("hidden");
  }
}


async function logout(){
  try{
    await fetch(`${API}?action=logout`);
  }catch(e){}
  sessionStorage.clear();
  location.href="login.html";
}

/* ================= ONLINE HEARTBEAT ================= */

async function pingOnline(){
  try{
    const r = await fetch(`${API}?action=online_ping&id=${ADMIN_ID}`);
    const j = await r.json();
    if(j.online!==undefined) rOnline.textContent=j.online;
  }catch(e){}
}

setInterval(pingOnline, 15000); // ping tiap 15 detik
pingOnline();

/* AUTO OFFLINE SAAT TUTUP TAB */
window.addEventListener("beforeunload", ()=>{
  navigator.sendBeacon(`${API}?action=online_leave&id=${ADMIN_ID}`);
});

/* AUTO CLOSE SIDEBAR SAAT KLIK LUAR (MOBILE) */
document.addEventListener("click", e=>{
  if(window.innerWidth < 768){
    if(
      !sidebar.contains(e.target) &&
      !e.target.closest("#sidebar") &&
      !e.target.closest("[onclick='toggleSidebar()']")
    ){
      sidebar.classList.add("w-0");
      sidebar.classList.remove("w-64","fixed","z-50","h-full","left-0","top-0");
    }
  }
});

document.addEventListener("keydown", e=>{
  if(e.key==="Escape" && window.innerWidth < 768){
    sidebar.classList.add("w-0");
    sidebar.classList.remove("w-64","fixed","z-50","h-full","left-0","top-0");
  }
});

</script>
</body>
</html>
