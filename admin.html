<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Admin Pengaduan</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-white min-h-screen p-6">

<div class="flex justify-between items-center mb-6">
  <h1 class="text-2xl font-bold">üõ† Dashboard Pengaduan</h1>
  <div class="flex gap-2">
    <select id="filter" onchange="render()" class="bg-slate-800 p-2 rounded">
      <option value="">Semua Status</option>
      <option value="pending">Pending</option>
      <option value="proses">Diproses</option>
      <option value="selesai">Selesai</option>
    </select>
    <button onclick="window.print()" class="bg-blue-600 px-4 py-2 rounded">Export PDF</button>
  </div>
</div>

<div id="cards" class="grid md:grid-cols-3 gap-4 mb-6"></div>

<div class="overflow-auto rounded-xl border border-slate-800">
<table class="w-full text-sm" id="t"></table>
</div>

<!-- MODAL -->
<div id="modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center">
<div class="bg-slate-900 p-6 rounded-xl w-full max-w-lg space-y-3">
<h2 class="text-xl font-bold mb-2">‚úèÔ∏è Update Pengaduan</h2>
<p id="mid" class="text-slate-400 text-sm"></p>

<select id="mstatus" class="w-full p-2 rounded bg-slate-800">
<option>Pending</option>
<option>Diproses</option>
<option>Selesai</option>
</select>

<textarea id="mnote" placeholder="Catatan penanganan"
class="w-full p-2 rounded bg-slate-800"></textarea>

<input id="mfoto" placeholder="Link foto hasil (Drive)"
class="w-full p-2 rounded bg-slate-800">

<div class="flex justify-end gap-2 pt-2">
<button onclick="modal.classList.add('hidden')" class="px-4 py-2 bg-slate-700 rounded">Batal</button>
<button onclick="save()" class="px-4 py-2 bg-green-600 rounded">Simpan</button>
</div>
</div>
</div>

<script>
if(!sessionStorage.getItem("admin")) location.href="login.html";

const API = "ISI_URL_APPS_SCRIPT";
const KEY = "12345";

let RAW=[], HEADER=[], CID="";

function badge(s){
  if(!s) return `<span class="px-2 py-1 rounded bg-gray-600 text-xs">UNKNOWN</span>`;
  s=s.toLowerCase();
  if(s.includes("selesai")) return `<span class="px-2 py-1 rounded bg-green-600 text-xs">SELESAI</span>`;
  if(s.includes("proses")) return `<span class="px-2 py-1 rounded bg-yellow-500 text-black text-xs">DIPROSES</span>`;
  return `<span class="px-2 py-1 rounded bg-red-600 text-xs">PENDING</span>`;
}

async function load(){
  const r = await fetch(`${API}?action=all&key=${KEY}`);
  const j = await r.json();
  RAW = j.data;
  HEADER = j.header;
  renderCards();
  render();
}

function renderCards(){
  const si = HEADER.findIndex(x=>x.toLowerCase().includes("status"));
  let p=0,d=0,s=0;
  RAW.forEach(r=>{
    const v=(r[si]||"").toLowerCase();
    if(v.includes("selesai")) s++;
    else if(v.includes("proses")) d++;
    else p++;
  });

  cards.innerHTML=`
  <div class="bg-red-600/20 border border-red-600 p-4 rounded-xl">Pending<br><b class="text-2xl">${p}</b></div>
  <div class="bg-yellow-500/20 border border-yellow-500 p-4 rounded-xl">Diproses<br><b class="text-2xl">${d}</b></div>
  <div class="bg-green-600/20 border border-green-600 p-4 rounded-xl">Selesai<br><b class="text-2xl">${s}</b></div>`;
}

function render(){
  const si = HEADER.findIndex(x=>x.toLowerCase().includes("status"));
  const f = filter.value;
  let h = "<tr class='bg-slate-800 text-left'>";
  HEADER.forEach(x=>h+=`<th class='p-2'>${x}</th>`);
  h+="<th>Aksi</th></tr>";

  RAW.forEach(r=>{
    const sv=(r[si]||"").toLowerCase();
    if(f && !sv.includes(f)) return;

    h+="<tr class='border-b border-slate-800 hover:bg-slate-900'>";
    r.forEach((x,i)=>{
      if(i===si) h+=`<td class='p-2'>${badge(x)}</td>`;
      else h+=`<td class='p-2'>${x||""}</td>`;
    });
    h+=`<td class='p-2'><button onclick="openModal('${r[0]}')" class="text-blue-400">Edit</button></td></tr>`;
  });

  t.innerHTML = h;
}

function openModal(id){
  CID=id;
  mid.innerText="Submission ID: "+id;
  modal.classList.remove("hidden");
}

function save(){
  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"update",
      key:KEY,
      id:CID,
      status:mstatus.value,
      catatan:mnote.value,
      foto:mfoto.value
    })
  }).then(()=>location.reload());
}

load();
</script>
</body>
</html>
