<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Admin Pengaduan</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-white min-h-screen flex">

<!-- SIDEBAR -->
<div class="w-64 bg-slate-900 border-r border-slate-800 p-4">
  <h2 class="text-xl font-bold mb-6">ðŸ›  Admin Pengaduan</h2>
  <nav class="space-y-2">
    <button onclick="show('dash')" class="w-full text-left p-2 rounded bg-slate-800">Dashboard</button>
    <button onclick="show('data')" class="w-full text-left p-2 rounded hover:bg-slate-800">Data Aduan</button>
    <button onclick="show('loket')" class="w-full text-left p-2 rounded hover:bg-slate-800">Mode Loket</button>
    <button onclick="logout()" class="w-full text-left p-2 rounded hover:bg-red-600 mt-10">Logout</button>
  </nav>
</div>

<!-- MAIN -->
<div class="flex-1 p-6 overflow-auto">

<!-- DASHBOARD -->
<div id="dash">
  <h1 class="text-2xl font-bold mb-4">Dashboard</h1>
  <div id="cards" class="grid md:grid-cols-3 gap-4"></div>
</div>

<!-- DATA -->
<div id="data" class="hidden">
  <h1 class="text-2xl font-bold mb-4">Data Pengaduan</h1>

  <input id="q" oninput="render()" placeholder="Cari ID / Nama / Unit / HP / Laporan..."
  class="w-full p-3 mb-4 rounded bg-slate-800 outline-none">

  <div class="overflow-auto border border-slate-800 rounded-xl">
    <table class="w-full text-sm" id="t"></table>
  </div>
</div>

<!-- MODE LOKET -->
<div id="loket" class="hidden">
  <h1 class="text-2xl font-bold mb-4">Mode Layar Loket Pelayanan</h1>
  <p class="text-slate-400 mb-3 text-sm">Tampilan ini cocok untuk monitor/TV. Auto refresh setiap 20 detik.</p>
  <div id="loketList" class="grid md:grid-cols-3 gap-4"></div>
</div>

</div>

<!-- MODAL -->
<div id="modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center">
<div class="bg-slate-900 p-6 rounded-xl w-full max-w-2xl space-y-3">
<h2 class="text-xl font-bold">Detail & Penanganan</h2>
<p id="mid" class="text-slate-400 text-sm"></p>

<div id="timeline" class="text-sm space-y-1 mb-2"></div>

<hr class="border-slate-700">

<div class="grid md:grid-cols-2 gap-3">
<input id="mpemeriksa" placeholder="Pemeriksa" class="p-2 bg-slate-800 rounded">
<input id="mtglperiksa" type="date" class="p-2 bg-slate-800 rounded">
<textarea id="mhasilperiksa" placeholder="Hasil Periksa" class="p-2 bg-slate-800 rounded md:col-span-2"></textarea>

<select id="mteknisi" class="p-2 bg-slate-800 rounded">
  <option value="">-- Pilih Teknisi --</option>
  <option>Rusidi</option>
  <option>Jamil</option>
  <option>Iwan</option>
  <option>Ichsan</option>
  <option>Ria</option>
</select>

<input id="mtglpenanganan" type="date" class="p-2 bg-slate-800 rounded">
<textarea id="mhasilpenanganan" placeholder="Hasil Penanganan" class="p-2 bg-slate-800 rounded md:col-span-2"></textarea>
</div>

<textarea id="mcatatan" placeholder="Catatan tambahan (log otomatis akan ditambahkan)"
class="w-full p-2 bg-slate-800 rounded"></textarea>

<div class="flex justify-end gap-2">
<button onclick="modal.classList.add('hidden')" class="px-4 py-2 bg-slate-700 rounded">Tutup</button>
<button onclick="save()" class="px-4 py-2 bg-green-600 rounded">Simpan</button>
</div>
</div>
</div>

<script>
if(!sessionStorage.getItem("admin")) location.href="login.html";

const API = "https://script.google.com/macros/s/AKfycbwdtVp4lgWaww8jtUHYtpd2Rj2hfbkwdD3T1OSCmSGRwBhGaDK_cgbE7YlpvwRnUuLP/exec";
const KEY = "12345";

let RAW=[], HEADER=[], CURRENT=[], CID="";

function show(id){
  dash.classList.add("hidden");
  data.classList.add("hidden");
  loket.classList.add("hidden");
  document.getElementById(id).classList.remove("hidden");
}

function logout(){
  sessionStorage.removeItem("admin");
  location.href="login.html";
}

function norm(s){ return String(s||"").toLowerCase(); }
function filled(v){ return v && String(v).trim()!==""; }

function getVal(h,d,k){
  const i = h.findIndex(x=>norm(x).includes(k));
  return i>-1 ? d[i] : "";
}

function getStatus(h,d){
  const p = filled(getVal(h,d,"pemeriksa")) && filled(getVal(h,d,"hasil periksa")) && filled(getVal(h,d,"tanggal periksa"));
  const s = filled(getVal(h,d,"teknisi")) && filled(getVal(h,d,"hasil penanganan")) && filled(getVal(h,d,"tanggal penanganan"));
  if(s) return ["SELESAI","green"];
  if(p) return ["DIPERIKSA","yellow"];
  return ["PENDING","red"];
}

async function load(){
  const r = await fetch(`${API}?action=all&key=${KEY}`);
  const j = await r.json();
  RAW=j.data; HEADER=j.header;
  buildCards();
  render();
  buildLoket();
}

function buildCards(){
  let p=0,d=0,s=0;
  RAW.forEach(r=>{
    const st=getStatus(HEADER,r)[0];
    if(st=="SELESAI") s++;
    else if(st=="DIPERIKSA") d++;
    else p++;
  });

  cards.innerHTML=`
  <div class="bg-red-600/20 border border-red-600 p-4 rounded-xl">Pending<br><b class="text-3xl">${p}</b></div>
  <div class="bg-yellow-500/20 border border-yellow-500 p-4 rounded-xl">Diperiksa<br><b class="text-3xl">${d}</b></div>
  <div class="bg-green-600/20 border border-green-600 p-4 rounded-xl">Selesai<br><b class="text-3xl">${s}</b></div>`;
}

function render(){
  const key = norm(q.value);
  let h="<tr class='bg-slate-800'>";
  HEADER.forEach(x=>h+=`<th class='p-2 text-left'>${x}</th>`);
  h+="<th>Status</th><th>Aksi</th></tr>";

  RAW.forEach(r=>{
    if(key && !r.join(" ").toLowerCase().includes(key)) return;
    const [st,c]=getStatus(HEADER,r);

    h+="<tr class='border-b border-slate-800 hover:bg-slate-900'>";
    r.forEach(x=>h+=`<td class='p-2'>${x||""}</td>`);
    h+=`<td class='p-2 text-${c}-400 font-bold'>${st}</td>`;
    h+=`<td class='p-2'><button onclick='openModal("${r[0]}")' class='text-blue-400'>Kelola</button></td></tr>`;
  });

  t.innerHTML=h;
}

function buildLoket(){
  let html="";
  RAW.forEach(r=>{
    const [st,c]=getStatus(HEADER,r);
    html+=`
    <div class="bg-slate-900 border border-slate-800 p-4 rounded-xl">
      <div class="text-sm text-slate-400">ID: ${r[0]}</div>
      <div class="font-bold text-lg">${r.join(" ").slice(0,60)}...</div>
      <div class="mt-2 text-${c}-400 font-bold text-xl">${st}</div>
    </div>`;
  });
  loketList.innerHTML=html;
}

function openModal(id){
  CID=id;
  CURRENT = RAW.find(r=>String(r[0])===String(id));
  mid.innerText="Submission ID: "+id;

  mpemeriksa.value = getVal(HEADER,CURRENT,"pemeriksa");
  mhasilperiksa.value = getVal(HEADER,CURRENT,"hasil periksa");
  mteknisi.value = getVal(HEADER,CURRENT,"teknisi");
  mhasilpenanganan.value = getVal(HEADER,CURRENT,"hasil penanganan");
  mcatatan.value = getVal(HEADER,CURRENT,"catatan");

  timeline.innerHTML = `
  ${filled(mpemeriksa.value) ? "ðŸŸ¡ Diperiksa" : "âšª Belum diperiksa"}<br>
  ${filled(mteknisi.value) ? "ðŸŸ¢ Ditangani / Selesai" : "âšª Belum ditangani"}
  `;

  modal.classList.remove("hidden");
}

function save(){
  const admin = sessionStorage.getItem("admin") || "ADMIN";
  const waktu = new Date().toLocaleString("id-ID");
  const log = `\n[${waktu}] Update oleh ${admin}: Pemeriksa=${mpemeriksa.value}, Teknisi=${mteknisi.value}`;

  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"update",
      key:KEY,
      id:CID,
      status:"",
      catatan:(mcatatan.value || "") + log,
      foto:""
    })
  }).then(()=>location.reload());
}

/* AUTO REFRESH MODE LOKET */
setInterval(()=>{ if(!loket.classList.contains("hidden")) load(); },20000);

load();
</script>
</body>
</html>
