<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Admin Aduan</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-950 text-white min-h-screen flex">

<!-- SIDEBAR -->
<div id="sidebar" class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col transition-all duration-300">
  <div class="p-4 border-b border-slate-800">
    <div class="text-xl font-bold">Admin Panel</div>
    <div class="text-xs text-slate-400">Pengaduan Rusunawa</div>
  </div>
  <div class="flex-1 p-4 space-y-2 text-sm">
    <div class="p-2 rounded bg-slate-800">ðŸ“‹ Data Aduan</div>
  </div>
  <div class="p-4 border-t border-slate-800">
    <button onclick="logout()" class="w-full bg-red-600/20 text-red-400 border border-red-600 px-3 py-2 rounded hover:bg-red-600 hover:text-white transition">
      ðŸšª Logout
    </button>
  </div>
</div>

<!-- MAIN -->
<div class="flex-1 flex flex-col">

<div class="bg-slate-900 border-b border-slate-800 p-3 flex items-center gap-3">
  <button onclick="toggleSidebar()" class="bg-slate-800 px-3 py-1 rounded">â˜°</button>
  <div class="font-semibold flex-1 text-center">Dashboard Admin Aduan</div>
</div>

<div class="p-4 space-y-4">

<!-- REKAP -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-3">
  <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
    <div class="text-slate-400 text-sm">Total Aduan</div>
    <div id="rTotal" class="text-2xl font-bold">0</div>
  </div>
  <div class="bg-yellow-500/20 border border-yellow-500 rounded-xl p-4">
    <div class="text-yellow-300 text-sm">Pending</div>
    <div id="rPending" class="text-2xl font-bold text-yellow-400">0</div>
  </div>
  <div class="bg-blue-600/20 border border-blue-600 rounded-xl p-4">
    <div class="text-blue-300 text-sm">Diperiksa</div>
    <div id="rPeriksa" class="text-2xl font-bold text-blue-400">0</div>
  </div>
  <div class="bg-green-600/20 border border-green-600 rounded-xl p-4">
    <div class="text-green-300 text-sm">Selesai</div>
    <div id="rSelesai" class="text-2xl font-bold text-green-400">0</div>
  </div>
</div>

<!-- FILTER -->
<div class="grid md:grid-cols-5 gap-2">
  <input id="search" oninput="renderTable()" placeholder="ðŸ” Cari aduan..."
    class="p-2 rounded bg-slate-800 border border-slate-700">

  <select id="filterStatus" onchange="renderTable()"
    class="p-2 rounded bg-slate-800 border border-slate-700">
    <option value="">Semua Status</option>
    <option value="PENDING">Pending</option>
    <option value="DIPERIKSA">Diperiksa</option>
    <option value="SELESAI">Selesai</option>
  </select>

  <select id="filterTahun" onchange="applyYear()"
    class="p-2 rounded bg-slate-800 border border-slate-700">
    <option value="">Semua Tahun</option>
  </select>

  <button onclick="exportExcel()"
    class="md:col-span-2 bg-emerald-600 hover:bg-emerald-700 transition rounded px-4 py-2 font-semibold">
    ðŸ“¤ Export Excel
  </button>
</div>

<!-- TABLE -->
<div class="bg-slate-900 border border-slate-800 rounded-xl overflow-auto max-h-[65vh]">
  <table class="w-full text-sm" id="table"></table>
</div>

</div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbwyiBhW4WoSehZ86jYH8CqW_k-GgTvVJ0QOkc1UT_4kXfY5cJZ0xGsMujELidj76TIcUg/exec";
const key = sessionStorage.getItem("adminKey");
if(!key) location.href="login.html";

let HEAD=[], RAW=[], DATA=[];

/* ================= LOAD ================= */
async function load(){
  const r = await fetch(`${API}?action=all&key=${key}`);
  const j = await r.json();
  HEAD=j.header; RAW=j.data; DATA=[...RAW];
  buildYear();
  hitungRekap();
  renderTable();
}
load();

/* ================= FOTO FORMAT ================= */
function renderFotoCell(val){
  if(!val) return "";
  const links = String(val).split(/\n|,/).map(x=>x.trim()).filter(Boolean);
  if(links.length === 1){
    return `<a href="${links[0]}" target="_blank" class="text-cyan-400 hover:underline">Lihat foto</a>`;
  }
  return links.map((l,i)=>`<a href="${l}" target="_blank" class="text-cyan-400 hover:underline block">Lihat foto ${i+1}</a>`).join("");
}

/* ================= TAHUN ================= */
function buildYear(){
  const idx = HEAD.indexOf("Submission Date");
  let years = [...new Set(RAW.map(r=>{
    const d=new Date(r[idx]); return isNaN(d)?null:d.getFullYear();
  }).filter(Boolean))].sort((a,b)=>b-a);

  filterTahun.innerHTML='<option value="">Semua Tahun</option>';
  years.forEach(y=>{
    filterTahun.innerHTML+=`<option value="${y}">${y}</option>`;
  });
}

function applyYear(){
  const y = filterTahun.value;
  if(!y){ DATA=[...RAW]; }
  else{
    const idx = HEAD.indexOf("Submission Date");
    DATA = RAW.filter(r=>{
      const d=new Date(r[idx]);
      return !isNaN(d) && d.getFullYear()==y;
    });
  }
  hitungRekap();
  renderTable();
}

/* ================= STATUS & REKAP ================= */
function getStatus(row){
  const m={}; HEAD.forEach((h,i)=>m[h]=row[i]);
  if(m["Teknisi"]&&m["Tanggal Penanganan"]&&m["Hasil Penanganan"]) return "SELESAI";
  if(m["Pemeriksa"]&&m["Tanggal Periksa"]&&m["Hasil Periksa"]) return "DIPERIKSA";
  return "PENDING";
}

function hitungRekap(){
  let p=0,d=0,s=0;
  DATA.forEach(r=>{
    const st=getStatus(r);
    if(st==="PENDING") p++;
    else if(st==="DIPERIKSA") d++;
    else if(st==="SELESAI") s++;
  });
  rTotal.textContent=DATA.length;
  rPending.textContent=p;
  rPeriksa.textContent=d;
  rSelesai.textContent=s;
}

/* ================= TABLE ================= */
function renderTable(){
  const rows = DATA.filter(r=>{
    const q=search.value.toLowerCase();
    const st=filterStatus.value;
    if(q && !r.join(" ").toLowerCase().includes(q)) return false;
    if(st && getStatus(r)!==st) return false;
    return true;
  });

  let h="<tr class='bg-slate-800 sticky top-0'>";
  HEAD.forEach(c=>h+=`<th class="p-2 border border-slate-700">${c}</th>`);
  h+="</tr>";

  rows.forEach(r=>{
    h+="<tr class='hover:bg-slate-800'>";
    r.forEach((v,i)=>{
      let val=v||"";
      if(HEAD[i].toLowerCase().includes("foto")) val=renderFotoCell(val);
      h+=`<td class="p-2 border border-slate-800 align-top">${val}</td>`;
    });
    h+="</tr>";
  });

  table.innerHTML=h;
}

/* ================= UTIL ================= */
function toggleSidebar(){ sidebar.classList.toggle("w-64"); sidebar.classList.toggle("w-0"); sidebar.classList.toggle("overflow-hidden");}
function logout(){ sessionStorage.clear(); location.href="login.html"; }
</script>
</body>
</html>
