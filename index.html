<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Tracking Aduan Rusunawa</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-white min-h-screen flex items-center justify-center">

<div class="bg-slate-900 p-6 rounded-xl w-full max-w-xl shadow">
  <h1 class="text-xl font-bold mb-4 text-center">Tracking Aduan Rusunawa</h1>

  <div class="flex gap-2 mb-4">
    <input id="ticket" type="text" placeholder="Masukkan Submission ID"
      class="w-full p-2 rounded bg-slate-800 border border-slate-700">
    <button onclick="cek()" class="bg-blue-600 px-4 rounded hover:bg-blue-700">
      Cek
    </button>
  </div>

  <!-- STATUS BAR -->
  <div id="statusBar" class="hidden mb-3 p-3 rounded text-center font-bold"></div>

  <div id="hasil" class="hidden bg-slate-800 p-4 rounded text-sm space-y-1"></div>
  <div id="msg" class="text-center text-red-400 text-sm"></div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbwyiBhW4WoSehZ86jYH8CqW_k-GgTvVJ0QOkc1UT_4kXfY5cJZ0xGsMujELidj76TIcUg/exec";

async function cek() {
  const id = document.getElementById("ticket").value.trim();
  const hasil = document.getElementById("hasil");
  const msg = document.getElementById("msg");
  const bar = document.getElementById("statusBar");

  hasil.classList.add("hidden");
  bar.classList.add("hidden");
  msg.textContent = "Memuat...";

  if (!id) {
    msg.textContent = "Submission ID wajib diisi.";
    return;
  }

  try {
    const res = await fetch(`${API}?action=track&id=${encodeURIComponent(id)}`);
    const json = await res.json();

    if (!json.found) {
      msg.textContent = "Data tidak ditemukan.";
      return;
    }

    msg.textContent = "";
    hasil.innerHTML = renderCustom(json.header, json.data);
    hasil.classList.remove("hidden");

    renderStatus(json.header, json.data);

  } catch (e) {
    msg.textContent = "Gagal menghubungi server.";
  }
}

/* ===== STATUS BAR LOGIC ===== */
function renderStatus(header, row) {
  const bar = document.getElementById("statusBar");
  const map = {};
  header.forEach((h,i)=>map[h]=row[i]);

  const diperiksa =
    map["Pemeriksa"] && map["Tanggal Periksa"] && map["Hasil Periksa"];

  const selesai =
    map["Teknisi"] && map["Tanggal Penanganan"] && map["Hasil Penanganan"];

  bar.className = "mb-3 p-3 rounded text-center font-bold";

  if (selesai) {
    bar.textContent = "STATUS: SELESAI";
    bar.classList.add("bg-green-600","text-white");
  } else if (diperiksa) {
    bar.textContent = "STATUS: DIPERIKSA";
    bar.classList.add("bg-blue-600","text-white");
  } else {
    bar.textContent = "STATUS: PENDING";
    bar.classList.add("bg-yellow-500","text-black");
  }

  bar.classList.remove("hidden");
}

/* ===== RENDER DATA ===== */
function renderCustom(header, row) {
  const map = {};
  header.forEach((h, i) => map[h] = row[i]);

  let html = "";

  // URUTAN KHUSUS
  add("Submission ID");
  add("RUSUNAWA");
  add("NOMOR UNIT/SARUSUNAWA");

  // TAMPILKAN LAINNYA (KECUALI PERNYATAAN & YANG SUDAH)
  header.forEach(h => {
    if (
      ["Submission ID","RUSUNAWA","NOMOR UNIT/SARUSUNAWA","PERNYATAAN"]
      .includes(h)
    ) return;
    add(h);
  });

  function add(label){
    const val = map[label];
    if (!val) return;
    if (label.toLowerCase().includes("foto")) {
      html += `<div><b>${label}:</b><br>
        <a href="${val}" target="_blank" class="text-blue-400 underline">Lihat Foto</a></div>`;
    } else {
      html += `<div><b>${label}:</b> ${val}</div>`;
    }
  }

  return html;
}
</script>
</body>
</html>
